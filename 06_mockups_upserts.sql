USE DIGIFAB;

/*
1) Ordens de Produção (Planejamento/Execução)
????????????????????????? Ordens de Produção ????????????????????????????
? [Período: 05–10/09/2025] [Linha: ?] [Produto: ?] [Buscar ?] [Nova OP] ?
?????????????????????????????????????????????????????????????????????????
? OP    ? Lote Produto  ? Linha    ? Produto ? Qtd     ? Início         ?
?????????????????????????????????????????????????????????????????????????
? OP-…1 ? LP-TAM-…-1    ? LIN-001  ? TAMPA   ? 10.000  ? 10/09 08:30.   ?
? OP-…2 ? LP-GAR-…-1    ? LIN-002  ? GARRAFA ?  5.000  ? 10/09 09:00.   ?
? …     ? …             ? …        ? …       ? …       ? …              ?
?????????????????????????????????????????????????????????????????????????
[Ver/Editar] [Apontar consumo] [Duplicar OP] [Excluir]

Ações (escrita) e tabelas:
	•	Criar/editar OP ? ORDEM_PRODUCAO (INSERT/UPDATE).
	•	Gerar planejamento de MP (ao salvar) ? MATERIA_PRIMA_ORDEM_PRODUCAO (INSERT calculado a partir do BOM).
	•	Duplicar ? nova linha em ORDEM_PRODUCAO + re-gerar MATERIA_PRIMA_ORDEM_PRODUCAO.

INSERT OP + planejamento (exemplo):
*/
-- 1) Criar OP
INSERT INTO ORDEM_PRODUCAO
 (CODIGO, ID_LOTE_PRODUTO, ID_LINHA_PRODUCAO, ID_RESPONSAVEL, QUANTIDADE_PRODUZIR, DT_HORA_INICIO)
VALUES
 (:CODIGO, :ID_LOTE_PRODUTO, :ID_LINHA_PRODUCAO, :ID_RESPONSAVEL, :QTD, :DT_INICIO);

SET @ID_OP := LAST_INSERT_ID();

-- 2) Gerar planejamento (BOM x quantidade)
INSERT INTO MATERIA_PRIMA_ORDEM_PRODUCAO
 (ID_ORDEM_PRODUCAO, ID_MATERIA_PRIMA, QUANTIDADE_PREVISTA)
SELECT
  @ID_OP, MP.ID_MATERIA_PRIMA, (MPP.QUANTIDADE_UNIDADE * :QTD)
FROM LOTE_PRODUTO LP
JOIN PRODUTO P              ON P.ID_PRODUTO = LP.ID_PRODUTO
JOIN MATERIA_PRIMA_PRODUTO MPP ON MPP.ID_PRODUTO = P.ID_PRODUTO
JOIN MATERIA_PRIMA MP          ON MP.ID_MATERIA_PRIMA = MPP.ID_MATERIA_PRIMA
WHERE LP.ID_LOTE_PRODUTO = :ID_LOTE_PRODUTO;

/*
2) Apontamento de Consumo de MP (por OP)
????????????? Apontar Consumo • OP OP-20250910-001 (LIN-001) ???????????????
? Planejado vs Consumido (kg)                                              ?
? MP      Planejado  Consumido  Saldo                                      ?
? PEAD    60,000     58,200     1,800                                      ?
????????????????????????????????????????????????????????????????????????????
? + Adicionar consumo                                                      ?
? [MP: PEAD] [Lote MP: ? LMP-PEAD-...] [Qtd (kg): 1,800] [Data: agora] [+] ?
????????????????????????????????????????????????????????????????????????????

Ações (escrita) e tabelas:
	•	Registrar consumo ? CONSUMO_LOTE_MP (INSERT).
	•	(opcional) Editar/estornar ? CONSUMO_LOTE_MP (UPDATE/DELETE).

CONSULTAS de apoio:
*/
-- Saldos por lote da MP selecionada (para combo de lotes)
SELECT LM.ID_LOTE_MP, LM.CODIGO, 
       ROUND(LM.QUANTIDADE - COALESCE(C.CONSUMO,0),3) AS SALDO_KG
FROM LOTE_MP LM
LEFT JOIN (SELECT ID_LOTE_MP, SUM(QUANTIDADE_CONSUMIDA) CONSUMO
           FROM CONSUMO_LOTE_MP GROUP BY ID_LOTE_MP) C
  ON C.ID_LOTE_MP = LM.ID_LOTE_MP
WHERE LM.ID_MATERIA_PRIMA = :ID_MATERIA_PRIMA
ORDER BY LM.DATA_RECEBIMENTO;  -- FEFO

-- INSERT consumo (valida saldo antes):
-- Validação rápida: saldo do lote suficiente
SELECT (LM.QUANTIDADE - COALESCE(C.CONSUMO,0)) >= :QTD AS OK
FROM LOTE_MP LM
LEFT JOIN (SELECT ID_LOTE_MP, SUM(QUANTIDADE_CONSUMIDA) CONSUMO 
           FROM CONSUMO_LOTE_MP GROUP BY ID_LOTE_MP) C
  ON C.ID_LOTE_MP = LM.ID_LOTE_MP
WHERE LM.ID_LOTE_MP = :ID_LOTE_MP;

-- Registro
INSERT INTO CONSUMO_LOTE_MP
 (ID_ORDEM_PRODUCAO, ID_LOTE_MP, QUANTIDADE_CONSUMIDA, DATA_CONSUMO)
VALUES
 (:ID_OP, :ID_LOTE_MP, :QTD, NOW());

 /*
 3) Recebimento de Lotes de MP
??????????????????????? Recebimento de MP ???????????????????????
? [Novo Lote]  [Filtrar por MP/Fornecedor/Período]              ?
?????????????????????????????????????????????????????????????????
? LOTE  ? MP       ? Forn.   ? Recebimento  ? Validade  ? Qtd   ?
?????????????????????????????????????????????????????????????????
? LMP…1 ? PET      ? GAIA    ? 01/09/2025   ? 01/03/26  ?150,000?
? LMP…2 ? PEAD     ? COOP…   ? 02/09/2025   ? 02/03/26  ?200,000?
?????????????????????????????????????????????????????????????????

Ações (escrita) e tabelas:
	•	Cadastrar/editar lote ? LOTE_MP (INSERT/UPDATE).
	•	(se necessário) Cadastrar fornecedor ? FORNECEDOR (INSERT).
	•	(se necessário) Cadastrar MP ? MATERIA_PRIMA (INSERT).

INSERT lote:
 */
INSERT INTO LOTE_MP
 (CODIGO, ID_MATERIA_PRIMA, ID_FORNECEDOR, NOTA_FISCAL,
  DATA_RECEBIMENTO, QUANTIDADE, DATA_VALIDADE, ID_RESPONSAVEL)
VALUES
 (:CODIGO, :ID_MP, :ID_FORN, :NF, :DT_REC, :QTD, :DT_VAL, :ID_USER);

/*
4) Cadastro de Produto & BOM
??????????????? Cadastro de Produto ???????????????   ????? BOM do Produto ?????
? [Novo Produto]                                  ?   ? [Adicionar MP ao BOM]  ?
? CODIGO: PRD-GAR-500                             ?   ? MP    Qtd/Unid (kg)    ?
? NOME: GARRAFA PET 500ML                         ?   ? PET   0,020            ?
? UNIDADE: UND  PESO_BRUTO: 0,020  EAN: 789…      ?   ? …                      ?
? [Salvar] [Duplicar]                             ?   ??????????????????????????
???????????????????????????????????????????????????

Ações (escrita) e tabelas:
	•	Produto ? PRODUTO (INSERT/UPDATE).
	•	BOM ? MATERIA_PRIMA_PRODUTO (INSERT/UPDATE/DELETE linhas).

Upsert de item de BOM (exemplo simples):
*/
INSERT INTO MATERIA_PRIMA_PRODUTO
 (ID_PRODUTO, ID_MATERIA_PRIMA, QUANTIDADE_UNIDADE)
VALUES (:ID_PRODUTO, :ID_MP, :QTD)
ON DUPLICATE KEY UPDATE QUANTIDADE_UNIDADE = VALUES(QUANTIDADE_UNIDADE);

/*
5) Linhas de Produção (Capacidade)
??????????????????????? Linhas de Produção ???????????????????????
? [Nova Linha]                                                   ?
??????????????????????????????????????????????????????????????????
? CÓDIGO  ? NOME         ? CAP/HORA     ? RESPONSÁVEL  ? STATUS  ?
??????????????????????????????????????????????????????????????????
? LIN-001 ? Injeção      ? 12000        ? Ana Bolizante? ATIVA   ?
? LIN-002 ? Sopro PET    ? 8000         ? Paul de Arara? ATIVA   ?
??????????????????????????????????????????????????????????????????
[Editar] [Inativar]

Ações (escrita) e tabelas:
LINHA_PRODUCAO (INSERT/UPDATE – campos CAPACIDADE_HORA, STATUS, ID_RESPONSAVEL).

UPDATE status/capacidade:
*/
UPDATE LINHA_PRODUCAO
SET CAPACIDADE_HORA = :CAP_HORA, STATUS = :STATUS, ID_RESPONSAVEL = :ID_USER
WHERE ID_LINHA_PRODUCAO = :ID;

/*
6) Lotes de Produto
????????????????????? Lotes de Produto ???????????????????
? [Novo Lote]                                            ?
??????????????????????????????????????????????????????????
? LOTE      ? Produto   ? Fábrica ? Produção     ? OPs   ?
??????????????????????????????????????????????????????????
? LP-GAR…1  ? Garrafa   ? FAB-POA ? 10/09/2025   ? 2     ?
? LP-TAM…1  ? Tampa     ? FAB-POA ? 10/09/2025   ? 1     ?
??????????????????????????????????????????????????????????

Ações (escrita) e tabelas:
LOTE_PRODUTO (INSERT/UPDATE). (Muitos times criam o lote antes da OP.)

INSERT lote de produto:
*/
INSERT INTO LOTE_PRODUTO
 (CODIGO, ID_PRODUTO, CIDADE_PRODUCAO, CODIGO_FABRICA, DATA_PRODUCAO)
VALUES
 (:CODIGO, :ID_PRODUTO, :CIDADE, :FAB, :DATA);

/*
7) Rastreabilidade (Consulta)
??????????????? Rastreabilidade ???????????????????????????????????
? [Filtrar: OP / Produto / Lote MP / Dia]                         ?
???????????????????????????????????????????????????????????????????
? OP       ? Produto       ? LoteProd ? MP       ? LoteMP? Qtd(kg)?
???????????????????????????????????????????????????????????????????
? OP-…002  ? Garrafa 500ml ? LP-GAR…  ? PET      ? LMP…1 ? 95,0   ?
? OP-…004  ? Pote 1L       ? LP-POT…  ? PEAD     ? LMP…2 ? 20,0   ?
???????????????????????????????????????????????????????????????????

Ações (leitura): usa VW_RASTREABILIDADE_CONSUMO.
Tabelas de origem: CONSUMO_LOTE_MP, ORDEM_PRODUCAO, LOTE_MP, MATERIA_PRIMA, LOTE_PRODUTO, PRODUTO.
*/



/*
Ligações entre telas (atalhos úteis)
 •  OP ? Apontar Consumo (leva ID_ORDEM_PRODUCAO).
 •  OP ? BOM do Produto (abre produto do lote ? PRODUTO + MATERIA_PRIMA_PRODUTO).
 •  Apontar Consumo ? Lotes MP (saldo) (abre VW_SALDO_LOTE_MP filtrada pela MP).
 •  Recebimento MP ? Rastreabilidade (ver onde o lote foi consumido).
 •  Linha de Produção ? Utilização (abre VW_UTILIZACAO_LINHA_DIA filtrada pela linha).

?

Pequenas regras de negócio (sucintas)
 •  Criar OP: sempre recalcular MATERIA_PRIMA_ORDEM_PRODUCAO com base na BOM atual do produto; se a BOM mudar depois, oferecer botão [Recalcular Planejado] (DELETE + INSERT das linhas).
 •  Apontar Consumo: não permitir consumo > saldo do lote; dar preferência a FEFO (por data de recebimento/validade).
 •  Recebimento: QUANTIDADE UNSIGNED; DATA_VALIDADE ? DATA_RECEBIMENTO.
 •  Capacidade: UTILIZACAO_REL nas views já considera CAPACIDADE_HORA * HORAS_ATIVAS.
*/

